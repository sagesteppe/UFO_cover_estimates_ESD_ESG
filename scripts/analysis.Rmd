---
title: "Compare ESD and ESG Quantitative Benchmarks"
author: 
output:
  pdf_document: default
  word_document: default
header-includes:
 - \usepackage[width=\textwidth]{caption}
always_allow_html: yes
csl: ../citations/citations/apa.csl
bibliography: ../citations/citations/citations.bib
link-citations: yes
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = F)
knitr::opts_chunk$set(dpi = 300) 
knitr::opts_chunk$set(message = F)
knitr::opts_chunk$set(warning = F)
```

# Introduction

The development of Ecological Sites (ES) and their descriptions (ESD's) represent an enormous effort on behalf of the Natural Resources Conservation Service (NRCS) (@bestelmeyer2015national). As mentioned in section XX, they do not yet form a continuous coast to coast, nor even across the field office data set (@twidwell2013national). In order to allay the significant amounts of effort required to develop these, and to make land management decisions in the interim alternative classification systems have been proposed (CITE). One system which incorporates the NRCS ESDs, and which provides continuous coverage across our study area, are the Ecological Site Groups (@nauman2022quantitative). 

The Ecological Site Groups developed largely by United States Geological Survey (USGS) researchers at the Southwest Biological Science Center in Moab [Utah], with assistance from BLM Colorado State Office Staff, are meant to both bridge the spatial gap in ESD development, and to provide a framework for  land management decisions at a scale larger than that which generally occurs at a BLM Field Office. The Ecological Site Groups were developed by grouping together similar ESD's, akin to the strictly interpretive approach - which seeks to reduce conceptual fineness - in section XX, and which will respond in a similar fashion to management actions (@duniway2016generalizing). To these initial groups the field data which largely informed the ESD creation, most notably soil physical parameters, and with the use of an objective and quantitative approaches, which make use of simple *Machine Learning (ML)* method *Random Forest* **section XX** were used to identify recurring themes in the dataset into groups, and then project these onto a 'map' which covers the Upper Colorado River Basin. 

While for most land management decisions at the UFO ESD's, when available, represent the best available scientific evidence upon which to inform decisions,  ESG's provide the best alternative for much of the field office, and in the future are likely to maintain influence for large scale decisions at the UFO. Herein we address questions regarding the similarity of estimates arising from ESG's and ESD's. In this report, we are using ESD's for the *reference state benchmarks* which they contain, in other words quantitative goals which we seek to compare land to, and seek to visualize the relationship between the standards of ESD's and ESG's. We also hope to understand which ecological sites are contained in which ES groups, in other words, where do our groups map out to? 

# Methods

The mean fractional cover of vegetation was manually transcribed from Table 3 of Appendix A from Nauman et al. 2022. The spatial data product which the study which was the outcome of the study was accessed from sciencebase.gov catalog on (Dec. 16, 2022). ESD quantitative benchmarks values, and AIM plot locations were cleaned in previous work (Section XX ESD Completion). All anaylses were performed in R version XX using RStudio VERSION on Linux Ubuntu 22.04 LTS. 

```{r}
library(tidyverse)
library(sf)
library(terra)
library(bipartite)

source('../../UFO_elements_of_style/scripts/ggplot_themes.R')
set.seed(51)

praw <- '../data/raw'
f <- list.files(praw, recursive = T)
```


```{r Import AIM plot locations subset to ESD verified and find their ESG via spatial operations}

ecosites <- read.csv(file.path(praw, f[grep('Plot_Tracking',f)] )) %>% 
  filter(ECO.SITE.MATCHED == T)

esg <- rast(file.path(praw, f[grep('ESGs.*tif$',f)]))

ecosites <- st_read('/media/sagesteppe/ExternalHD/UFO_cartography/AIM_plots_outcomes/plots_outcomes.shp', 
                 quiet = T) %>% # let us grab the spatial data from this real quick
  select(PLOT.ID = Plot_ID) %>% 
  st_transform(26912) %>% 
  st_buffer(27.5) %>% 
  right_join(., ecosites, by = 'PLOT.ID')  %>% 
  vect() %>% 
  project(., crs(esg))

mode <- function(codes){as.numeric(which.max(tabulate(codes)))}

esg2plots <- extract(esg, ecosites, method = 'simple', weights = T, ID = T) %>% 
  group_by(ID) %>% 
  summarise(Value = mode(ESG)) %>% 
  cbind(PLOT.ID = ecosites$PLOT.ID, .)

esg2plots <- data.frame(levels(esg)) %>% # extract lookup table from raster
  right_join(., esg2plots, by = 'Value') %>% 
  select(ESG, PLOT.ID) 
ecosites_mapped <- as.data.frame(ecosites) %>% 
  select(ECO.SITE, PLOT.ID) 

ESD2ESG_map <- left_join(esg2plots, ecosites_mapped, by = 'PLOT.ID') %>% 
  mutate(
    ESG = str_replace_all(ESG, ' ', "_"), 
    ESG = str_replace(ESG, ',_', '_and_'), 
    ESG = str_replace(ESG, 'Semiarid_Warm', 'SAW'), 
    ESG = str_replace(ESG, 'Semiarid_Cool', 'SAC'),  
    ESG = str_replace(ESG, 'Arid_Warm_', 'AW'))  
  
rm(esg2plots, ecosites_mapped)
```


Their were two major objectives in this section. The first is to determine which ESD's map to which ESG's. In theory the ESD's had a one to one relationship with the ESG, in other words an ESD has a single ESG to which it is related (but see). However, not all of these relationships were noted in the appendices or supplemental materials. 

The second objective was to reaffirm the accuracy of the predicted surface map in the UFO. In publication the accuracy of the final product was calculated as being 57.4% (@nauman2022quantitative). However, due to certain features which are more difficult to reliably classify, certain products may score higher in certain areas without these harder to identify features.  

The study utilized 18 of the UFO's (NUMBER) ecosites. We can determine how often the spatial product mapped to the appropriate ESG under multiple circumstances. 1) How often did the PREDOMINANT ESG get returned by the ESD 2) what proportion of all plots were matched correctly to an ESG from the spatial product ? 

```{r Use ideal lookup table from publication}

ref_lookup <- read.csv(file.path(praw, f[grep('Appendix',f)] )) %>% 
  select(Ecological.Site.ID, Final.Soil.Geomorphic.Unit, Climate.Zone) %>% 
  filter(Ecological.Site.ID %in% ESD2ESG_map$ECO.SITE) %>% 
  mutate(
    Climate.Zone = str_replace(Climate.Zone, 'Semiarid_Warm', 'SAW'), 
    Climate.Zone = str_replace(Climate.Zone, 'Semiarid_Cool', 'SAC'),  
    Climate.Zone = str_replace(Climate.Zone, 'Arid_Warm', 'AW'),  
    Final.Soil.Geomorphic.Unit = snakecase::to_parsed_case(Final.Soil.Geomorphic.Unit) 
    ) %>% 
  mutate(Final.Soil.Geomorphic.Unit = case_when( 
    Climate.Zone == 'SAW' & Final.Soil.Geomorphic.Unit %in% c('Shallow', 'Deep_Rocky') ~ 'Shallow_and_Deep_Rocky', 
    TRUE ~ Final.Soil.Geomorphic.Unit
  )) %>% 
  unite('ESG', Climate.Zone:Final.Soil.Geomorphic.Unit, sep = '_-_') 

ESG_present <- nrow(ref_lookup) 

rm(f, praw)
```

To test whether we were extracting and processing the correct ESG from the gridded surface two comparisons of raster extraction methods were attempted. The first, is typically performed at UFO, is to buffer the point to represent the entire AIM plot and extract to that area, and chose the categorical class with the most cells per value. The other option is to extract from the gridded surface directly to the point geometry. The proportion of correctly classified points from a subset of ESD's for which the ESG's are definitively known is reported, and the higher performing method, buffering, was used for the duration of the analyses. 
  
```{r test raster extraction methods}

ecosites <- st_read('/media/sagesteppe/ExternalHD/UFO_cartography/AIM_plots_outcomes/plots_outcomes.shp', 
                 quiet = T) %>% # let us grab the spatial data from this real quick
  select(PLOT.ID = Plot_ID) %>% 
  st_transform(26912) 

ESG4simulation <- filter(ESD2ESG_map, ECO.SITE %in% ref_lookup$Ecological.Site.ID) %>% 
  select(-ESG) %>% 
  left_join(., ecosites) %>% 
  st_as_sf() %>% 
  vect() %>% 
  project(., crs(esg))

ESG4simulation_buff <- ESG4simulation %>% 
  st_as_sf() %>% 
  st_transform(26912) %>% 
  st_buffer(27.5) %>% 
  vect() %>% 
  project(., crs(esg))

known <- st_as_sf(ESG4simulation) %>% 
  st_drop_geometry()

## Extract Values for the plot center ##
bN <- extract(esg, ESG4simulation, method = 'simple') %>% 
  mutate(test = 'point') %>% 
  cbind(known)

## Extract Values for the buffer plots
bY <- extract(esg, ESG4simulation_buff, method = 'simple',  bind = T) 
bY <- extract(esg, ESG4simulation_buff, method = 'simple') %>% 
  group_by(ID) %>% 
  summarise(Value = mode(ESG)) %>% 
  cbind(known)
bY <- data.frame(levels(esg)) %>% 
  right_join(., bY, by = 'Value') %>% 
  select(-Value) %>% 
  mutate(test = 'polygon') 

test_results <- rbind(bN, bY) %>% 
  mutate(
    ESG = str_replace_all(ESG, ' ', "_"),
    ESG = str_replace_all(ESG, ',', "_and"),
    ESG = str_remove(ESG, 'No_Climate_Group_-_'),
    ESG = str_replace(ESG, 'Semiarid_Warm', 'SAW'),
    ESG = str_replace(ESG, 'Semiarid_Cool', 'SAC'), 
    ESG = str_replace(ESG, 'Arid_Warm', 'AW'),
    ) %>% 
  select(-ID, -PLOT.ID) %>% 
  mutate(RESULT = if_else(ESG %in% ref_lookup$ESG & ECO.SITE %in% ref_lookup$Ecological.Site.ID, 1, 0)) 

p2p <- test_results %>% 
  group_by(test) %>% 
  summarize(Prop = sum(RESULT)/n()) # polygon gives slightly better results

rm(bY, bN, ESG4simulation, ESG4simulation_buff, ecosites)
```

To determine whether the raster dataset gives a higher or lower performance accuracy in the UFO portion of it's range the AIM plots with ESD's which are known to map directly to ESG's were utilized. These plots were extracted from the ESG gridded surface and the proportion of each ESG which was correctly and incorrectly mapped were calculated.  

```{r Proportion of Correct ESG matching}

# The percent of ESG's which were classified as such, and the percent of those mappings which
# are accurate. 
esg_correct <- test_results %>% 
  filter(test == 'polygon') %>% 
  group_by(ESG) %>% 
  mutate(Correct = sum(RESULT), 
         Total = n(),
         Incorrect = Total - Correct) %>% 
  distinct(ESG, Correct, Incorrect, Total, .keep_all = F) %>% 
  pivot_longer(cols = c(Correct, Incorrect), values_to = 'Response_V', names_to = 'Response')

number_incorrect <- esg_correct %>% 
  filter(Response == 'Incorrect', Total == Response_V) %>% 
  nrow()
number_correct_esg <- esg_correct %>% 
  filter(Response == 'Correct', Total == Response_V) %>% 
  nrow()

# Proportion of which plots per ESD are correctly identified by the raster surface. 
esd_correct <- test_results %>% 
  filter(test == 'polygon') %>% 
  group_by(ECO.SITE) %>% 
  mutate(Correct = sum(RESULT), 
         Total = n(),
         Incorrect = Total - Correct) %>% 
  distinct(ECO.SITE, Correct, Incorrect, Total, .keep_all = F) %>% 
  pivot_longer(cols = c(Correct, Incorrect), values_to = 'Response_V', names_to = 'Response')

esd_corr_plots <- ggplot(esd_correct, aes(y = Response_V, x = ECO.SITE, fill= Response)) +
    geom_bar(position="stack", stat="identity") +
    theme(strip.background = element_blank(), 
          panel.background = element_blank(),
          plot.title = element_text(hjust = 0.5)
          ) +
    scale_fill_manual('Identification:', 
                      values = c('Correct' = 'darkslategray3', 'Incorrect' = 'darkred')) +
  scale_x_discrete(guide = guide_axis(n.dodge=5)) +
  labs(title = 'Proportion of Plots mapped to their ESG', y = 'Number of Plots', x = 'Ecological Site') 

# ESD's differ in the proportion of plots which may be mapped over to ESG. 
# In general our results here echo the paper, 1/3 of records will be incorrectly mapped from 
# the single output prediction. 

prop_D_map2_G <- esd_correct %>% 
  filter(Response == 'Correct') %>% 
  ungroup() %>% 
  summarize(prop_correct = sum(Response_V) / sum(Total))
            
rm(theme_boxplot, theme_prop_bar, esg, esg_correct, test_results, esd_correct)
```

To determine the accuracy of mapping individual ESDs directly to ESG's a bipartite network was created using all AIM Plots with verified ESD's, all statistics were calculated using the package 'bipartite' (@ DORRRRRRRRRRRRMAN). This approach was used to search for patterns in these data, given both the high number of ESG's and ESD's. 

```{r Create Networks to show relationships between pixels and classification.}

ESD2ESG_wide <- ESD2ESG_map %>% 
  select(-PLOT.ID) 

ob <- with(ESD2ESG_wide, table(ESG, ECO.SITE))
EsdEsg_network <- apply(as.matrix.noquote(ob),2,as.numeric)
rownames(EsdEsg_network) <- rownames(ob)

orig_mod <- computeModules(EsdEsg_network)

# Higher Level refers to the ESD's , Lower level to the ESGs

NLINteractions <- networklevel(EsdEsg_network, index = c(
  'linkage density', 
  'weighted nestedness', 
  'H2'))

GLInteractions <- grouplevel(EsdEsg_network, index = c(
  'number of species', # no expectations is what went in
  'mean number of links', # for ESD expect 1, ESG > 1
  'mean number of shared partners', # for ESG > 1, for ESD still greater than 1 as many can pool into one ESG
  'niche overlap', # should be very low for ESG, should be higher for ESD, but still relatively low. 
  'C score' # should be VERY HIGH for upper, low for lower.  
  ))

SLInteractions <- specieslevel(EsdEsg_network, index = c(
  'degree',  # number of links per species, ESD should be 1, ESG > 1
  'species strength', 
  'effective partners',
  'nestedrank'))

rm(ob, EsdEsg_network, NLINteractions, GLInteractions, SLInteractions)
```

```{r Create a clean network of ESDs which map to an ESG}

# ' the clean network '

cleanNET1 <- ESD2ESG_wide %>% 
  ungroup() %>% 
  filter(ECO.SITE %in% ref_lookup$Ecological.Site.ID) %>% 
  select(ECO.SITE) %>% 
  left_join(., ref_lookup, by = c('ECO.SITE' = 'Ecological.Site.ID'))

cleanNET2 <- ESD2ESG_wide %>% 
  ungroup() %>% 
  filter(!ECO.SITE %in% ref_lookup$Ecological.Site.ID) %>% 
  group_by(ECO.SITE) %>% 
  filter(n()== 1)

cleanNET3 <-  ESD2ESG_wide %>% 
  ungroup() %>% 
  filter(!ECO.SITE %in% ref_lookup$Ecological.Site.ID) %>% 
  group_by(ECO.SITE) %>%
  filter(n() >= 2) %>% 
  
  add_tally(name = 'NO_ESD') %>% #these ESG's match perfectly between all plots 
  group_by(ECO.SITE, ESG) %>% # within the ESD ! F048AY918CO 4/4, R034XY403CO 5/5 
  add_tally(name = 'ESD_in_ESG') %>% 
  filter(NO_ESD == ESD_in_ESG) %>% 
  select(-NO_ESD, -ESD_in_ESG)

cleanNET4 <- ESD2ESG_wide %>% 
  ungroup() %>% 
  filter(!ECO.SITE %in% ref_lookup$Ecological.Site.ID) %>% 
  group_by(ECO.SITE) %>%
  filter(n() >= 2) %>% 
  
  add_tally(name = 'NO_ESD') %>% #these ESG's match perfectly between all plots 
  group_by(ECO.SITE, ESG) %>% # within the ESD ! F048AY918CO 4/4, R034XY403CO 5/5 
  add_tally(name = 'ESD_in_ESG') %>% 
  filter(NO_ESD != ESD_in_ESG) %>% 
  
  filter(ESD_in_ESG / NO_ESD > 0.65) %>% 
  distinct() %>% 
  slice(rep(1:n(), each = NO_ESD)) %>%  # now have to remove these from the next set
  select(-NO_ESD, -ESD_in_ESG)

cleanNet <- rbind(cleanNET1, cleanNET2, cleanNET3, cleanNET4)

ob <- with(cleanNet, table(ESG, ECO.SITE))
EsdEsg_network <- apply(as.matrix.noquote(ob),2,as.numeric)
rownames(EsdEsg_network) <- rownames(ob)
clean_mod <- computeModules(EsdEsg_network)
```


```{r Create subset Network for remaining ESDs which needan ESG}

# ' the dirty network'

dirtyNet <- ESD2ESG_wide %>% 
  ungroup() %>% 
  filter(!ECO.SITE %in% ref_lookup$Ecological.Site.ID) %>% # the groups of these ESD's are known #/ 157 plots
  
  group_by(ECO.SITE) %>% # these ESD's had only a single plot, and we will just #/ 8 plots
  filter(n() >= 2) %>% # accept whichever ESG it is mapped to. 
  
  add_tally(name = 'NO_ESD') %>% #these ESG's match perfectly between all plots 
  group_by(ECO.SITE, ESG) %>% # within the ESD ! F048AY918CO 4/4, R034XY403CO 5/5 
  add_tally(name = 'ESD_in_ESG') %>% 
  filter(NO_ESD != ESD_in_ESG) %>% 
  
  filter(ESD_in_ESG / NO_ESD < 0.65) %>%  # sites with > 65% of plots to an ESG will be assigned as such. 
  filter(!ECO.SITE %in% c('R048AY238CO', 'R048AY306UT')) # R048AY238CO, R048AY306UT


ob <- with(dirtyNet, table(ESG, ECO.SITE))
EsdEsg_network <- apply(as.matrix.noquote(ob),2,as.numeric)
rownames(EsdEsg_network) <- rownames(ob)
dirt_mod <- computeModules(EsdEsg_network)

rm(ob, EsdEsg_network)
```

While the final output classification gridded surface had a classification accuracy of 67% the next two output layers, have slightly different predictions and 86% of the time will contain the correct ESG. Each of the three layers were extracted to a site, and the most commonly occurring ESG across all combinations was selected as the soil geomorphic group. All climate zones were also extracted to the points, and most commonly occurring climate zone was selected as the climate zone to classify these sites in the SGU framework. 

```{r Classify Remaining ESDs to an ESG based on the most commonly observed one across all Plots }
praw <- '../data/raw'
f <- list.files(praw, recursive = T)

sgu1  <- rast( file.path(praw, f[grep('SGU_1st.*tif$',f)]) )
sgu2  <- rast( file.path(praw, f[grep('SGU_2nd.*tif$',f)]) )
sgu3  <- rast( file.path(praw, f[grep('SGU_3rd.*tif$',f)]) )
c_zones <- rast( file.path(praw, f[grep('Zones.*tif$', f)]) )

ecosites <- st_read('/media/sagesteppe/ExternalHD/UFO_cartography/AIM_plots_outcomes/plots_outcomes.shp', 
                 quiet = T) %>% # let us grab the spatial data from this real quick
  select(PLOT.ID = Plot_ID) %>% 
  st_transform(26912) %>% 
  st_buffer(27.5) %>% 
  right_join(ESD2ESG_map, ecosites, by = 'PLOT.ID') %>% 
  filter(ECO.SITE %in% dirtyNet$ECO.SITE) %>% 
  vect() %>% 
  project(., crs(sgu1)) 

cz_lkp <- data.frame(levels(c_zones)) 
clim_zones <- extract(c_zones, ecosites, method = 'simple') %>% 
  group_by(ID) %>% summarise(ClimZone = mode(ClimZone)) %>% # mode of original input dataset
  left_join(., cz_lkp, by = c('ClimZone' = 'Value')) %>% 
  select(ID, ClimZone = ClimZone.y)  %>% 
  cbind(., PLOT.ID = st_as_sf(ecosites)) %>% 
  select(ID, ClimZone, PLOT.ID = PLOT.ID.PLOT.ID, ECO.SITE = PLOT.ID.ECO.SITE) %>% 
  ungroup() %>% 
  mutate(ClimZoneM = as.numeric(factor( # this all convoluted was much better before but then I myselfed. 
      ClimZone, levels = c("Arid Warm", "Semiarid Warm", "Semiarid Cool"), ordered = TRUE))) %>% 
  split(., .$ECO.SITE) %>% 
  map(., .f = list(. %>% mutate(ClimZoneM = mode(ClimZoneM)))) %>% 
  bind_rows() %>% 
  mutate(
    ClimZoneM = str_replace(ClimZoneM, '1', 'AW'), 
    ClimZoneM = str_replace(ClimZoneM, '2', 'SAW')
    ) %>% 
  distinct(ECO.SITE, ClimZoneM)

sgu1_ex <- extract(sgu1, ecosites, method = 'simple') %>% 
  group_by(ID) %>% summarise(SGU1 = mode(SGU)) 
sgu2 <- extract(sgu2, ecosites, method = 'simple') %>% 
  group_by(ID) %>% summarise(SGU2 = mode(SGU)) 
sgu3 <- extract(sgu3, ecosites, method = 'simple') %>% 
  group_by(ID) %>%  summarise(SGU3 = mode(SGU)) 
sgu <- data.frame(sgu1_ex, 'SGU2' =  sgu2$SGU2, 'SGU3' = sgu3$SGU3, 
                  st_as_sf(ecosites) %>% select(PLOT.ID, ECO.SITE) )

sgu <- sgu %>% 
  st_drop_geometry() %>% 
  split(., .$ECO.SITE) %>% 
  map(., .f = list(. %>% dplyr::select(2:4) %>% 
                     as.matrix() %>% 
        table(.) %>% which.max(.) %>% names(.) )) %>% 
  bind_rows() %>%  t() %>%  data.frame() %>% 
  rownames_to_column('ECO.SITE') %>% 
  rename(ESG_Code = '.')

sguvals <- data.frame(levels(sgu1)) %>% 
  mutate(Value = as.character(Value))

sgu <- left_join(sgu, sguvals, by = c('ESG_Code' = 'Value')) %>% 
  left_join(., clim_zones, by = 'ECO.SITE') %>% 
  unite('ESG', ClimZoneM, SGU, sep = '_-_') %>% 
  mutate(ESG = str_replace_all(ESG, ' ', '_'),
         ESG = str_replace(ESG, 'SAW_-_Deep_Rocky', 'SAW_-_Shallow_and_Deep_Rocky'),
         ESG = str_replace(ESG, 'SAW_-_Loamy_Uplands', 'SAW_-_Sandy_Uplands_and_Loamy_Uplands')) %>% 
  select(-ESG_Code) 

rm(sgu1_ex, sgu1, sgu2, sgu3, ecosites, cz_lkp, sguvals, c_zones, dirtyNet,
   mode, clim_zones, ESD2ESG_map)
```

A final ESD - ESG lookup table was assembled using these criteria. 

```{r ESD ESG Lookup table}

lookuptable <- bind_rows(distinct(cleanNet), sgu)

finalNET <- ESD2ESG_wide %>% 
  select(ECO.SITE) %>% left_join(lookuptable) %>% 
  mutate(ID = 1:nrow(.))
write.csv(finalNET, '../data/processed/ESD-ESG-Lookup-Table.csv', row.names = F)

ob <- with(finalNET, table(ESG, ECO.SITE))
EsdEsg_network <- apply(as.matrix.noquote(ob),2,as.numeric)
rownames(EsdEsg_network) <- rownames(ob)
final_mod <- computeModules(EsdEsg_network)

rm(ob, EsdEsg_network, finalNET, cleanNet, ESD2ESG_wide)
```


## Compare ESG benchmarks to ESD benchmarks

```{r Import Quantitative Fractional Cover Benchmarks, eval = F}

ESD_cover <- read.csv(file.path(praw, f[grep('ESD_Quantitative',f)] )) %>% 
  rowwise() %>% 
  mutate(MEAN = sum(LOWER,  UPPER, na.rm = T)/2)  %>% 
  filter(!COVER_TYPE %in% c('BAREGROUND', 'LITTER')) %>% 
  left_join(., lookuptable, by = 'ECO.SITE') %>% 
  drop_na(ESG) %>% 
  select(ECO.SITE, COVER_TYPE, MEAN) %>% 
  mutate( MODEL = 'ESD')

ESG_cover <- read.csv(file.path(praw, f[grep('FractionalCover', f)] )) %>% 
  rowwise() %>% 
  mutate(GRASS = sum(Sacaton, C3_Perennial_Grass, C4_Perennial_Grass, Grass),
         SHRUB = sum(Saltbush, Shadescale, Shrub)) %>% 
  select(Climate:SoilGeomorphicUnits, GRASS, SHRUB, FORB = Forb, TREE = Tree) %>% 
  pivot_longer(cols = GRASS:TREE, names_to = 'COVER_TYPE', values_to = 'MEAN') %>% 
  unite('ESG', Climate:SoilGeomorphicUnits, sep = '_-_') %>% 
  mutate(
    ESG = str_replace_all(ESG, ' ', "_"),
    ESG = str_remove(ESG, 'No_Climate_Group_-_'),
    ESG = str_replace(ESG, 'Semiarid_warm', 'SAW'),
    ESG = str_replace(ESG, 'Semiarid_Cool', 'SAC'), 
    ESG = str_replace(ESG, 'Arid_Warm_', 'AW'), 
    ) %>% 
#  left_join(., lookuptable) %>% 
  drop_na() %>% 
  rename(CONCEPT = ESG) %>% 
  mutate(MODEL = 'ESG')

# v <- inner_join(ESD_cover, ESG_cover, by = 'ECO.SITE')

```

```{r Facet wrap density plots of ESD values with geom point ESG value, eval = F}

ggplot(ob, aes(MEAN_X, MEAN_Y, color = MODEL)) +
  geom_jitter() +
  facet_grid(rows = vars(modules), cols = vars(COVER_TYPE)) +
  theme_bw()

```

```{r Remove variables used in methods}
rm(f, praw, lookuptable)
```

# Results

The method of extracting the ESG from the gridded surface to plot had virtually no influence on the accuracy of the ESG. Regardless the method of buffering the point to the real size of the AIM plot was used as it slightly outperformed plot centers on the `r nrow(known)` known sites,  `r p2p[(p2p$test == 'point'),]$Prop` to `r p2p[(p2p$test == 'polygon'),]$Prop`.

```{r Proportion of plots per esd mapped correctly from the gridded data set, fig.cap="Proportion of Plots in ESDs which were included in the ESGS and should map over unequivocally to an ESG"}
esd_corr_plots
rm(esd_corr_plots)
```

`r nrow(known)` AIM points were in the look up values for ESG... XX of these ESDs were included directly in the making of XX ESGs . The ESG gridded surface was able to correctly place `r prop_D_map2_G` plots to the appropriate ESG, rather than the 57.4% reported for the entire study area.

Of the `r nrow(known)` AIM plots with classified ESD's, `r ESG_present` which are included in the ESG reference materials, the number of ESG's erroneously included are `r number_incorrect`, while the number of accurately extracted ESG's is `r number_correct_esg`, while `r ESG_present-number_correct_esg` were not returned at all (???). 

```{r Plot network of original Input data, fig.cap="Initial Relationship Between Field Verified ESD and ESG extracted from the gridded surface"}
plotweb(orig_mod@moduleWeb)
```

The initial extraction of ESG to AIM points was problematic (Figure 2). We were able to improve upon these results via multiple steps in sequential order. 1) Look up table values form publication (as mentioned `r nrow(known)` plots, `r length(unique(known$ECO.SITE))` esds, and `r length(unique(ref_lookup$ESG))` ESGs), 2) `r nrow(cleanNET2)` plots/ESD's had a sole representative, 3) `r nrow(cleanNET3)` plots where all ESDs were in one ESG where > 2 plots per ESD `r length(unique(cleanNET3))`, 4)  `r nrow(cleanNET4)` plots where > 65% of the  `r length(unique(cleanNET4))` (Figure 3).


```{r Plot Network of cleaning data, fig.cap="Relationships Between ESDs and ESGs midway through the cleaning process"}
par(mfrow=c(2,1)) 
plotweb(clean_mod@moduleWeb)
plotweb(dirt_mod@moduleWeb)
par(mfrow=c(1,1))
```

The remaining `r nrow(sgu)` ESD's were all mapped to `r length(unique(sgu$ESG))` ESG via the methods of summarizing both the SGU and climate zones. The final lookup table of ESD to ESG mapping is in Figure 4.  

```{r Plot Network of cleaned data a lookup table, fig.cap="Relationship between ESDs and ESGs at end of process"}
plotweb(final_mod@moduleWeb)
rm(orig_mod, clean_mod, dirt_mod, final_mod)
```

```{r}
rm(known, prop_D_map2_G, number_correct_esg, number_incorrect, p2p, cleanNET1, 
   cleanNET2, cleanNET3, cleanNET4, sgu, ESG_present, ref_lookup)
```


```{r}

```


# Conclusions

The relationship between the novel ESG's and the ESD's...

For best accuracy using the ESG's it is best practice to verify the ESD using traditional methods rather than spatial operations. 


\newpage

# References

