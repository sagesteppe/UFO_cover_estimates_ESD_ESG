---
title: "Compare ESD and ESG Quantitative Benchmarks"
author: 
output:
  pdf_document: default
  word_document: default
header-includes:
 - \usepackage[width=\textwidth]{caption}
always_allow_html: yes
csl: ../citations/citations/apa.csl
bibliography: ../citations/citations/citations.bib
link-citations: yes
---



```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = F)
knitr::opts_chunk$set(dpi = 300) 
knitr::opts_chunk$set(message = F)
knitr::opts_chunk$set(warning = F)
```

# Introduction



> "QUOTE WILL GO HERE SUMMARIZING WHAT ESGS ARE ALL ABOOT"
>  
> `r tufte::quote_footer('--- Nauman et al. 2022')`

The Ecological Site Groups developed by ... are at a theoretically more coarse resolution than Ecological Site Descriptions. These data are intended to support broader land management decisions. These data were developed in an explicitly quantitative framework, using remote sensing derived products. Due to their intended usage, and process of generation, they have been completed for the entire Colorado Plateau...

# Methods
Here we determine how similar they are to the ESD's for which we have verified AIM plots in. In order to determine if ESG's may serve as a drop-in-substitute for areas of the field office which do not have completed ESD's...


```{r}
library(tidyverse)
library(sf)
library(terra)
library(bipartite)

set.seed(51)
```

```{r Import Quantitative Fractional Cover Benchmarks}
praw <- '../data/raw'
f <- list.files(praw, recursive = T)

ESD_quant <- read.csv(file.path(praw, f[grep('ESD_Quantitative',f)] )) %>% 
  rowwise() %>% 
  mutate(MEAN = sum(LOWER,  UPPER, na.rm = T)/2) 

ESG_cover <- read.csv(file.path(praw, f[grep('FractionalCover', f)] )) %>% 
  rowwise() %>% 
  mutate(GRASS = sum(Sacaton, C3_Perennial_Grass, C4_Perennial_Grass, Grass),
         SHRUB = sum(Saltbush, Shadescale, Shrub)) %>% 
  select(Climate:SoilGeomorphicUnits, GRASS, SHRUB, FORB = Forb, TREE = Tree) %>% 
  pivot_longer(cols = GRASS:TREE, names_to = 'COVER_TYPE', values_to = 'MEAN') 

```

```{r Import AIM plot locations subset to ESD verified and find their ESG via spatial operations}

ecosites <- read.csv(file.path(praw, f[grep('Plot_Tracking',f)] )) %>% 
  filter(ECO.SITE.MATCHED == T)

esg <- rast(file.path(praw, f[grep('ESGs.*tif$',f)]))

ecosites <- st_read('/media/sagesteppe/ExternalHD/UFO_cartography/AIM_plots_outcomes/plots_outcomes.shp', 
                 quiet = T) %>% # let us grab the spatial data from this real quick
  select(PLOT.ID = Plot_ID) %>% 
  st_transform(26912) %>% 
  st_buffer(27.5) %>% 
  right_join(., ecosites, by = 'PLOT.ID')  %>% 
  vect() %>% 
  project(., crs(esg))

mode <- function(codes){as.numeric(which.max(tabulate(codes)))}

esg2plots <- extract(esg, ecosites, method = 'bilinear', weights = T, ID = T) %>% 
  group_by(ID) %>% 
  summarise(Value = mode(ESG)) %>% 
  cbind(PLOT.ID = ecosites$PLOT.ID, .)

esg2plots <- data.frame(levels(esg)) %>% # extract lookup table from raster
  right_join(., esg2plots, by = 'Value') %>% 
  select(ESG, PLOT.ID)
ecosites <- as.data.frame(ecosites) %>%
  select(ECO.SITE, PLOT.ID)

ESD2ESG_map <- left_join(esg2plots, ecosites, by = 'PLOT.ID')
  
rm(mode, esg, f, praw, esg2plots, ecosites)
```


```{r}

ESD2ESG_wide <- ESD2ESG_map %>% 
  mutate(
    ESG = str_replace_all(ESG, ' ', "_"),
    ESG = str_replace(ESG, 'Semiarid_Warm', 'SAW'),
    ESG = str_replace(ESG, 'Semiarid_Cool', 'SAC'),
    ESG = str_replace(ESG, 'Arid_Warm_', 'AW')) %>% 
  select(-PLOT.ID) 

ob <- with(ESD2ESG_wide, table(ESG, ECO.SITE))
EsdEsg_network <- apply(as.matrix.noquote(ob),2,as.numeric)
rownames(EsdEsg_network) <- rownames(ob)

mod <- computeModules(EsdEsg_network)
plotModuleWeb(mod)

# Higher Level refers to the ESD's , Lower level to the ESGs
grouplevel(EsdEsg_network,
             index = c(
               'number of species', # no expectations is what went in
               'mean number of links', # for ESD expect 1, ESG > 1
               'mean number of shared partners', # for ESG > 1, for ESD still greater than 1 as many can pool into one ESG
               'niche overlap', # should be very low for ESG, should be higher for ESD, but still relatively low. 
               'weighted nestedness'
               ))


plotweb(mod@moduleWeb)

modules <- module2constraints(mod)
module_membership <- data.frame(c(rownames(EsdEsg_network), colnames(EsdEsg_network)), modules) 
colnames(module_membership) <- c("vertices", "modules") 

module_membership <- module_membership %>% 
  mutate(vertices = str_remove_all(vertices, ','))

# rm(ob, mod, EsdEsg_network, modules, ESD2ESG_map)
```

```{r Facet wrap density plots of ESD values with geom point ESG value}


ESD_quant <- ESD_quant %>% 
  select('CONCEPT' = ECO.SITE, COVER_TYPE, MEAN) %>% 
  mutate(MODEL = 'ESD')

ob <- ESG_cover %>% 
  unite('ESG', Climate:SoilGeomorphicUnits, sep = '_-_') %>% 
  mutate(
    ESG = str_replace_all(ESG, ' ', "_"),
    ESG = str_remove(ESG, 'No_Climate_Group_-_'),
    ESG = str_replace(ESG, 'Semiarid_warm', 'SAW'),
    ESG = str_replace(ESG, 'Semiarid_Cool', 'SAC'), # do need to go back to clean up names
    ESG = str_replace(ESG, 'Arid_Warm_', 'AW')) %>% # of some of these strata
  mutate(MODEL = 'ESG') %>% 
  rename(CONCEPT = ESG) %>% 
  bind_rows(ESD_quant) %>% 
  right_join(., module_membership, by = c('CONCEPT' = 'vertices')) %>% 
  mutate(MEAN_X = MEAN, MEAN_Y = MEAN) %>% 
  filter(COVER_TYPE %in% c('FORB', 'GRASS', 'SHRUB', 'TREE'))

ggplot(ob, aes(MEAN_X, MEAN_Y, color = MODEL)) +
  geom_jitter() +
  facet_grid(rows = vars(modules), cols = vars(COVER_TYPE)) +
  theme_bw()


```



# Results

We run multiple tests of correlation coefficients to determine similarity between these two data sets. ...

# Conclusions

The relationship between the novel ESG's and the ESD's...


