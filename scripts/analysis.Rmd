---
title: "Compare ESD and ESG Quantitative Benchmarks"
author: 
output:
  pdf_document: default
  word_document: default
header-includes:
 - \usepackage[width=\textwidth]{caption}
always_allow_html: yes
csl: ../citations/citations/apa.csl
bibliography: ../citations/citations/citations.bib
link-citations: yes
---



```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = F)
knitr::opts_chunk$set(dpi = 300) 
knitr::opts_chunk$set(message = F)
knitr::opts_chunk$set(warning = F)
```

# Introduction

The development of Ecological Sites (ES) and their descriptions (ESD's) represent an enormous effort on behalf of the Natural Resources Conservation Service (NRCS) (@bestelmeyer2015national). As mentioned in section XX, they do not yet form a continuous coast to coast, nor even across the field office data set (@twidwell2013national). In order to allay the significant amounts of effort required to develop these, and to make land management decisions in the interim alternative classification systems have been proposed (CITE). One system which incorporates the NRCS ESDs, and which provides continuous coverage across our study area, are the Ecological Site Groups (@nauman2022quantitative). 

The Ecological Site Groups developed largely by United States Geological Survey (USGS) researchers at the Southwest Biological Science Center in Moab [Utah], with assistance from BLM Colorado State Office Staff, are meant to both bridge the spatial gap in ESD development, and to provide a framework for  land management decisions at a scale larger than that which generally occurs at a BLM Field Office. The Ecological Site Groups were developed by grouping together similar ESD's, akin to the strictly interpretive approach - which seeks to reduce conceptual fineness - in section XX, and which will respond in a similar fashion to management actions (@duniway2016generalizing). To these initial groups the field data which largely informed the ESD creation, most notably soil physical parameters, and with the use of an objective and quantitative approaches, which make use of simple *Machine Learning (ML)* method *Random Forest* **section XX** were used to identify recurring themes in the dataset into groups, and then project these onto a 'map' which covers the Upper Colorado River Basin. 

While for most land management decisions at the UFO ESD's, when available, represent the best available scientific evidence upon which to inform decisions,  ESG's provide the best alternative for much of the field office, and in the future are likely to maintain influence for large scale decisions at the UFO. Herein we address questions regarding the similarity of estimates arising from ESG's and ESD's. In this report, we are using ESD's for the *reference state benchmarks* which they contain, in other words quantitative goals which we seek to compare land to, and seek to visualize the relationship between the standards of ESD's and ESG's. We also hope to understand which ecological sites are contained in which ES groups, in other words, where do our groups map out to? 

# Methods

The mean fractional cover of vegetation was manually transcribed from Table 3 of Appendix A from Nauman et al. 2022. The spatial data product which the study which was the outcome of the study was accessed from sciencebase.gov catalog on (Dec. 16, 2022). ESD quantitative benchmarks values, and AIM plot locations were cleaned in previous work (Section XX ESD Completion). All anaylses were performed in R version XX using RStudio VERSION on Linux Ubuntu 22.04 LTS. 

```{r}
library(tidyverse)
library(sf)
library(terra)
library(bipartite)

source('../../UFO_elements_of_style/scripts/ggplot_themes.R')
set.seed(51)
```

```{r Import Quantitative Fractional Cover Benchmarks}
praw <- '../data/raw'
f <- list.files(praw, recursive = T)

ESD_quant <- read.csv(file.path(praw, f[grep('ESD_Quantitative',f)] )) %>% 
  rowwise() %>% 
  mutate(MEAN = sum(LOWER,  UPPER, na.rm = T)/2) 

ESG_cover <- read.csv(file.path(praw, f[grep('FractionalCover', f)] )) %>% 
  rowwise() %>% 
  mutate(GRASS = sum(Sacaton, C3_Perennial_Grass, C4_Perennial_Grass, Grass),
         SHRUB = sum(Saltbush, Shadescale, Shrub)) %>% 
  select(Climate:SoilGeomorphicUnits, GRASS, SHRUB, FORB = Forb, TREE = Tree) %>% 
  pivot_longer(cols = GRASS:TREE, names_to = 'COVER_TYPE', values_to = 'MEAN') 

```

```{r Import AIM plot locations subset to ESD verified and find their ESG via spatial operations}

ecosites <- read.csv(file.path(praw, f[grep('Plot_Tracking',f)] )) %>% 
  filter(ECO.SITE.MATCHED == T)

esg <- rast(file.path(praw, f[grep('ESGs.*tif$',f)]))

ecosites <- st_read('/media/sagesteppe/ExternalHD/UFO_cartography/AIM_plots_outcomes/plots_outcomes.shp', 
                 quiet = T) %>% # let us grab the spatial data from this real quick
  select(PLOT.ID = Plot_ID) %>% 
  st_transform(26912) %>% 
  st_buffer(27.5) %>% 
  right_join(., ecosites, by = 'PLOT.ID')  %>% 
  vect() %>% 
  project(., crs(esg))

mode <- function(codes){as.numeric(which.max(tabulate(codes)))}

esg2plots <- extract(esg, ecosites, method = 'simple', weights = T, ID = T) %>% 
  group_by(ID) %>% 
  summarise(Value = mode(ESG)) %>% 
  cbind(PLOT.ID = ecosites$PLOT.ID, .)

esg2plots <- data.frame(levels(esg)) %>% # extract lookup table from raster
  right_join(., esg2plots, by = 'Value') %>% 
  select(ESG, PLOT.ID)
ecosites_mapped <- as.data.frame(ecosites) %>%
  select(ECO.SITE, PLOT.ID)

ESD2ESG_map <- left_join(esg2plots, ecosites_mapped, by = 'PLOT.ID') %>% 
  mutate(
    ESG = str_replace_all(ESG, ' ', "_"),
    ESG = str_replace(ESG, ',_', '_and_'),
    ESG = str_replace(ESG, 'Semiarid_Warm', 'SAW'),
    ESG = str_replace(ESG, 'Semiarid_Cool', 'SAC'), 
    ESG = str_replace(ESG, 'Arid_Warm_', 'AW')) 
  
rm(esg2plots, ecosites_mapped)
```


Their were two major objectives in this section. The first is to determine which ESD's map to which ESG's. In theory the ESD's had a one to one relationship with the ESG, in other words an ESD has a single ESG to which it is related (but see). However, not all of these relationships were noted in the appendices or supplemental materials. 

The second objective was to reaffirm the accuracy of the predicted surface map in the UFO. In publication the accuracy of the final product was calculated as being 57.4% (@nauman2022quantitative). However, due to certain features which are more difficult to reliably classify, certain products may score higher in certain areas without these harder to identify features.  

The study utilized 18 of the UFO's (NUMBER) ecosites. We can determine how often the spatial product mapped to the appropriate ESG under multiple circumstances. 1) How often did the PREDOMINANT ESG get returned by the ESD 2) what proportion of all plots were matched correctly to an ESG from the spatial product ? 

```{r Use ideal lookup table from publication}

ref_lookup <- read.csv(file.path(praw, f[grep('Appendix',f)] )) %>% 
  select(Ecological.Site.ID, Final.Soil.Geomorphic.Unit, Climate.Zone) %>% 
  filter(Ecological.Site.ID %in% ESD2ESG_map$ECO.SITE) %>% 
  mutate(
    Climate.Zone = str_replace(Climate.Zone, 'Semiarid_Warm', 'SAW'),
    Climate.Zone = str_replace(Climate.Zone, 'Semiarid_Cool', 'SAC'), 
    Climate.Zone = str_replace(Climate.Zone, 'Arid_Warm', 'AW'),
    Final.Soil.Geomorphic.Unit = snakecase::to_parsed_case(Final.Soil.Geomorphic.Unit)
    ) %>% 
  mutate(Final.Soil.Geomorphic.Unit = case_when(
    Climate.Zone == 'SAW' & Final.Soil.Geomorphic.Unit %in% c('Shallow', 'Deep_Rocky') ~ 'Shallow_and_Deep_Rocky',
    TRUE ~ Final.Soil.Geomorphic.Unit
  )) %>% 
  unite('ESG', Climate.Zone:Final.Soil.Geomorphic.Unit, sep = '_-_')

ESG_present <- nrow(ref_lookup)

rm(f, praw)
```

To test whether we were extracting and processing the correct ESG from the gridded surface two comparisons of raster extraction methods were attempted. The first, is typically performed at UFO, is to buffer the point to represent the entire AIM plot and extract to that area, and chose the categorical class with the most cells per value. The other option is to extract from the gridded surface directly to the point geometry. 
  
```{r test raster extraction methods}

ecosites <- st_read('/media/sagesteppe/ExternalHD/UFO_cartography/AIM_plots_outcomes/plots_outcomes.shp', 
                 quiet = T) %>% # let us grab the spatial data from this real quick
  select(PLOT.ID = Plot_ID) %>% 
  st_transform(26912) 

ESG4simulation <- filter(ESD2ESG_map, ECO.SITE %in% ref_lookup$Ecological.Site.ID) %>% 
  select(-ESG) %>% 
  left_join(., ecosites) %>% 
  st_as_sf() %>% 
  vect() %>% 
  project(., crs(esg))

ESG4simulation_buff <- ESG4simulation %>% 
  st_as_sf() %>% 
  st_transform(26912) %>% 
  st_buffer(27.5) %>% 
  vect() %>% 
  project(., crs(esg))

known <- st_as_sf(ESG4simulation) %>% 
  st_drop_geometry()

## Extract Values for the plot center ##
bN <- extract(esg, ESG4simulation, method = 'simple') %>% 
  mutate(test = 'point') %>% 
  cbind(known)

## Extract Values for the buffer plots
bY <- extract(esg, ESG4simulation_buff, method = 'simple',  bind = T) 
bY <- extract(esg, ESG4simulation_buff, method = 'simple') %>% 
  group_by(ID) %>% 
  summarise(Value = mode(ESG)) %>% 
  cbind(known)
bY <- data.frame(levels(esg)) %>% 
  right_join(., bY, by = 'Value') %>% 
  select(-Value) %>% 
  mutate(test = 'polygon') 

test_results <- rbind(bN, bY) %>% 
  mutate(
    ESG = str_replace_all(ESG, ' ', "_"),
    ESG = str_replace_all(ESG, ',', "_and"),
    ESG = str_remove(ESG, 'No_Climate_Group_-_'),
    ESG = str_replace(ESG, 'Semiarid_Warm', 'SAW'),
    ESG = str_replace(ESG, 'Semiarid_Cool', 'SAC'), 
    ESG = str_replace(ESG, 'Arid_Warm', 'AW'),
    ) %>% 
  select(-ID, -PLOT.ID) %>% 
  mutate(RESULT = if_else(ESG %in% ref_lookup$ESG & ECO.SITE %in% ref_lookup$Ecological.Site.ID, 1, 0)) 

p2p <- test_results %>% 
  group_by(test) %>% 
  summarize(Prop = sum(RESULT)/n()) # polygon gives slightly better results

rm(bY, bN, ESG4simulation, ESG4simulation_buff)
```


```{r Proportion of Correct ESG matching}

# The percent of ESG's which were classified as such, and the percent of those mappings which
# are accurate. 
esg_correct <- test_results %>% 
  filter(test == 'polygon') %>% 
  group_by(ESG) %>% 
  mutate(Correct = sum(RESULT), 
         Total = n(),
         Incorrect = Total - Correct) %>% 
  distinct(ESG, Correct, Incorrect, Total, .keep_all = F) %>% 
  pivot_longer(cols = c(Correct, Incorrect), values_to = 'Response_V', names_to = 'Response')

number_incorrect <- esg_correct %>% 
  filter(Response == 'Incorrect', Total == Response_V) %>% 
  nrow()
number_correct_esg <- esg_correct %>% 
  filter(Response == 'Correct', Total == Response_V) %>% 
  nrow()

# Proportion of which plots per ESD are correctly identified by the raster surface. 
esd_correct <- test_results %>% 
  filter(test == 'polygon') %>% 
  group_by(ECO.SITE) %>% 
  mutate(Correct = sum(RESULT), 
         Total = n(),
         Incorrect = Total - Correct) %>% 
  distinct(ECO.SITE, Correct, Incorrect, Total, .keep_all = F) %>% 
  pivot_longer(cols = c(Correct, Incorrect), values_to = 'Response_V', names_to = 'Response')

ggplot(esd_correct, aes(y = Response_V, x = ECO.SITE, fill= Response)) +
    geom_bar(position="stack", stat="identity") +
    theme(strip.background = element_blank(), 
          panel.background = element_blank(),
          plot.title = element_text(hjust = 0.5)
          ) +
    scale_fill_manual('Identification:', 
                      values = c('Correct' = 'darkslategray3', 'Incorrect' = 'darkred')) +
  scale_x_discrete(guide = guide_axis(n.dodge=5)) +
  labs(title = 'Proportion of Plots mapped to their ESG', y = 'Number', x = 'Ecological Site') 

# ESD's differ in the proportion of plots which may be mapped over to ESG. 
# In general our results here echo the paper, 1/3 of records will be incorrectly mapped from 
# the single output prediction. 

prop_D_map2_G <- esd_correct %>% 
  filter(Response == 'Correct') %>% 
  ungroup() %>% 
  summarize(prop_correct = sum(Response_V)/ sum(Total))
            
            
rm( mode, theme_boxplot,
   theme_prop_bar, esg, esg_correct, ref_lookup, test_results)
```


```{r Create Networks to show relationships between pixels and classification.}

ESD2ESG_wide <- ESD2ESG_map %>% 
  select(-PLOT.ID) 

ob <- with(ESD2ESG_wide, table(ESG, ECO.SITE))
EsdEsg_network <- apply(as.matrix.noquote(ob),2,as.numeric)
rownames(EsdEsg_network) <- rownames(ob)

mod <- computeModules(EsdEsg_network)
plotModuleWeb(mod)
plotweb(mod@moduleWeb)


# Higher Level refers to the ESD's , Lower level to the ESGs

NLINteractions <- networklevel(EsdEsg_network, index = c(
  'linkage density', 
  'weighted nestedness', 
  'H2'))

GLInteractions <- grouplevel(EsdEsg_network, index = c(
  'number of species', # no expectations is what went in
  'mean number of links', # for ESD expect 1, ESG > 1
  'mean number of shared partners', # for ESG > 1, for ESD still greater than 1 as many can pool into one ESG
  'niche overlap', # should be very low for ESG, should be higher for ESD, but still relatively low. 
  'C score' # should be VERY HIGH for upper, low for lower.  
  ))

SLInteractions <- specieslevel(EsdEsg_network, index = c(
  'degree',  # number of links per species, ESD should be 1, ESG > 1
  'species strength', 
  'effective partners',
  'nestedrank'))

modules <- module2constraints(mod)
module_membership <- data.frame(c(rownames(EsdEsg_network), colnames(EsdEsg_network)), modules) 
colnames(module_membership) <- c("vertices", "modules") 

module_membership <- module_membership %>% 
  mutate(vertices = str_remove_all(vertices, ','),  
         vertices = str_replace(vertices, '_Finer_Uplands_and_Clay_Uplands', '_Finer_and_Clay_Uplands'),
         vertices = str_replace(vertices, 'Sandy_Uplands_and_Loamy_Uplands', 'Sandy_and_Loamy_Uplands')
         )

rm(ob, mod, EsdEsg_network, modules, ESD2ESG_map)
```

It can be inferred from the above image is that from a per pixel perspective, the mapping between pixels and ESG's is of limited utility. Rather we need to utilize the direct look up tables from the publication... which miss most of our ecosites again... 

The ES which had there ESG associations, as well as those with only a single linkage to ESG were removed from the input dataset, and a second network was created FIGURE XX. These ES were manually mapped to the most probable ESG via the Dichotomous Key in Nauman et al. 2022. 




## Compare ESG benchmarks to ESD benchmarks


```{r Facet wrap density plots of ESD values with geom point ESG value}

ESD_quant <- ESD_quant %>% 
  select('CONCEPT' = ECO.SITE, COVER_TYPE, MEAN) %>% 
  mutate(MODEL = 'ESD')

ob <- ESG_cover %>% 
  unite('ESG', Climate:SoilGeomorphicUnits, sep = '_-_') %>% 
  mutate(
    ESG = str_replace_all(ESG, ' ', "_"),
    ESG = str_remove(ESG, 'No_Climate_Group_-_'),
    ESG = str_replace(ESG, 'Semiarid_warm', 'SAW'),
    ESG = str_replace(ESG, 'Semiarid_Cool', 'SAC'), 
    ESG = str_replace(ESG, 'Arid_Warm_', 'AW'), 
    ) %>% # of some of these strata
  mutate(MODEL = 'ESG') %>% 
  rename(CONCEPT = ESG) %>% 
  bind_rows(ESD_quant) %>% 
  right_join(., module_membership, by = c('CONCEPT' = 'vertices')) %>% 
  mutate(MEAN_X = MEAN, MEAN_Y = MEAN) %>% 
  filter(COVER_TYPE %in% c('FORB', 'GRASS', 'SHRUB', 'TREE'))

ggplot(ob, aes(MEAN_X, MEAN_Y, color = MODEL)) +
  geom_jitter() +
  facet_grid(rows = vars(modules), cols = vars(COVER_TYPE)) +
  theme_bw()

```


# Results


The method of extracting the ESG from th gridded surface to plot had virtually no influence on the accuracy of the ESG. Regardless the method of buffering the point to the real size of the AIM plot was used as it slightly outperformed plot centers,  `r p2p[(p2p$test == 'point'),]$Prop` to `r p2p[(p2p$test == 'polygon'),]$Prop`.

`r nrow(known)` AIM points were in the look up values for ESG... XX of these ESDs were included directly in the making of XX ESGs . The ESG gridded surface was able to correctly place `r prop_D_map2_G` plots to the appropriate ESG, rather than the 57.4% reported for the entire study area.

Of the `r nrow(known)` AIM plots with classified ESD's, `r ESG_present` which are included in the ESG reference materials, the number of ESG's erroneously included are `r number_incorrect`, while the number of accurately extracted ESG's is `r number_correct_esg`, while `r ESG_present-number_correct_esg` were not returned at all (???). 


```{r}
rm(known, prop_D_map2_G, number_correct_esg, number_incorrect)
```


# Conclusions

The relationship between the novel ESG's and the ESD's...

For best accuracy using the ESG's it is best practice to verify the ESD using traditional methods rather than spatial operations. 



